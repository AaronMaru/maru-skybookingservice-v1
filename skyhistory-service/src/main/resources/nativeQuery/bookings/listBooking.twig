SELECT
b.id AS bookingId,
b.booking_code AS bookingCode,
b.itinerary_ref AS pnrCode,
b.trip_type AS tripType,
b.cont_email AS contEmail,
b.cont_phone AS contPhone,
b.cont_phonecode AS contPhoneCode,
(SELECT CONCAT(su.last_name,' ', su.first_name) AS staffName
	FROM stakeholder_users su
	WHERE su.id = b.stakeholder_user_id
) AS staffName,
(SELECT CASE WHEN SUM(`pass_qty`) IS NOT NULL THEN SUM(`pass_qty`) ELSE 0 END
	FROM booking_travel_itineraries bti
	WHERE bti.booking_id = b.id
	AND bti.pass_type = "ADT"
) AS `adult`,
(SELECT CASE WHEN SUM(`pass_qty`) IS NOT NULL THEN SUM(`pass_qty`) ELSE 0 END
	FROM booking_travel_itineraries bti
	WHERE bti.booking_id = b.id
	AND bti.pass_type = "CNN"
) AS `child`,
(SELECT CASE WHEN SUM(`pass_qty`) IS NOT NULL THEN SUM(`pass_qty`) ELSE 0 END
	FROM booking_travel_itineraries bti
	WHERE bti.booking_id = b.id
	AND bti.pass_type = "INF"
) AS `infant`,
(SELECT CASE WHEN SUM(`pass_qty`) IS NOT NULL THEN SUM(`pass_qty`) ELSE 0 END
	FROM booking_travel_itineraries bti
	WHERE bti.booking_id = b.id
) AS `totalPass`,

(SELECT (SELECT cabin_name FROM cabins WHERE cabin_code = bod.cabin_name LIMIT 1) AS cabinName
	FROM booking_origin_destinations bod
	WHERE bod.booking_id = b.id
	AND bod.parent_id IS NOT NULL
	LIMIT 1
) AS cabinName,

(SELECT bod.cabin_name
	FROM booking_origin_destinations bod
	WHERE bod.booking_id = b.id
	AND bod.parent_id IS NOT NULL
	LIMIT 1
) AS cabinCode,

( b.total_amount + b.markup_amount + b.markup_pay_amount ) AS totalAmount,
b.dis_pay_met_amount AS disPayment,
b.currency_code AS currencyCode,
b.cont_fullname AS contName,
b.created_at AS bookDate,
b.`status`,
CASE

	WHEN (b.`status` = 11 AND (

				SELECT COUNT(bod.id)
				FROM booking_origin_destinations bod
				WHERE bod.booking_id = b.id

				-- Where Date and Convert UTZ date
				AND DATE(

					-- Flight depature datetime and convert to UTC
					CONVERT_TZ(bod.dep_date, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END ), '+00:00')

					-- User locale current time zone and convert to UTC
					) >= CONVERT_TZ(CURRENT_TIMESTAMP, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END ), '+00:00')

				ORDER BY bod.id DESC
				LIMIT 1

			) > 0

		) THEN "upcoming"

	WHEN (b.`status` = 11 AND (

				SELECT COUNT(bod.id)
				FROM booking_origin_destinations bod
				WHERE bod.booking_id = b.id

				-- Where Date and Convert TZ date
				AND DATE(

					-- Flight depature datetime and convert to UTC
					CONVERT_TZ(bod.dep_date, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END ), '+00:00')

					-- User locale current time zone and convert to UTC
					) < CONVERT_TZ(CURRENT_TIMESTAMP, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END ) , '+00:00')

				ORDER BY bod.id DESC
				LIMIT 1

			) > 0

		) THEN "complete"

	WHEN (b.`status` IN (3)) THEN "cancel"
	WHEN (b.`status` IN (10, 12, 4)) THEN  "fail"

END AS statusKey

FROM bookings b


-- Condition by Booking status
WHERE b.status IN (11, 10, 4, 12, 3)

-- CHECK USERS
AND CASE WHEN :stake = "skyuser"
    THEN (b.stakeholder_user_id = :skyuserId AND b.stakeholder_company_id IS NULL)
    ELSE
        -- Condition for Skyowner
        CASE WHEN
                :role = 'admin'
            THEN
                b.stakeholder_user_id = :skyuserId OR b.stakeholder_company_id = :companyId
            ELSE
                b.stakeholder_user_id = :skyuserId AND b.stakeholder_company_id = :companyId
            END
    END


-- FILTER BOOKING
AND CASE WHEN
        :action = 'filter'
    THEN

        -- Param: startRange and endRange
        ( b.total_amount + b.markup_amount + b.markup_pay_amount ) >= :startRange AND ( b.total_amount + b.markup_amount + b.markup_pay_amount ) <= :endRange

        -- By trip type
        -- Param: tripType
        AND CASE WHEN
                :tripType != 'all'
            THEN
                b.trip_type = :tripType
            ELSE
                b.status IN (11, 10, 4, 12, 3)
            END

        -- By stakeholder name
        -- Param: bookByName
        AND CASE WHEN
                :bookByName != 'all'
            THEN
                (SELECT COUNT(su.id) FROM stakeholder_users su WHERE su.id = b.stakeholder_user_id AND CONCAT(su.last_name,' ', su.first_name) LIKE '%' :bookByName '%') > 0
            ELSE
                b.status IN (11, 10, 4, 12, 3)
            END


        -- By Flying From and To
        -- Param: flyingFrom, flyingTo
        AND CASE WHEN
                b.trip_type = 'Return'
            THEN

                -- Condition with return
                ( SELECT COUNT(fbod.id) FROM booking_origin_destinations fbod
                    WHERE fbod.booking_id = b.id
                    AND fbod.parent_id IS NOT NULL
                    AND CASE WHEN :flyingFrom != 'all' THEN fbod.dep_location_code = :flyingFrom ELSE b.status IN (11, 10, 4, 12, 3) END
                    ORDER BY fbod.id ASC
                    LIMIT 1
                ) > 0  AND ( SELECT COUNT(fbod.id)
                    FROM booking_origin_destinations fbod
                    WHERE fbod.booking_id = b.id
                    AND fbod.parent_id IS NOT NULL
                    AND CASE WHEN :flyingTo != 'all' THEN fbod.dep_location_code = :flyingTo ELSE b.status IN (11, 10, 4, 12, 3) END
                    ORDER BY fbod.id DESC
                    LIMIT 1
                ) > 0

            ELSE

                -- Condition with ONEWAY and Multicity
                ( SELECT COUNT(fbod.id)
                    FROM booking_origin_destinations fbod
                    WHERE fbod.booking_id = b.id
                    AND fbod.parent_id IS NOT NULL
                    AND CASE WHEN :flyingFrom != 'all' THEN fbod.dep_location_code = :flyingFrom ELSE b.status IN (11, 10, 4, 12, 3) END
                    ORDER BY fbod.id ASC
                    LIMIT 1
                ) > 0  AND ( SELECT COUNT(fbod.id)
                    FROM booking_origin_destinations fbod
                    WHERE fbod.booking_id = b.id
                    AND fbod.parent_id IS NOT NULL
                    AND  CASE WHEN :flyingTo != 'all' THEN fbod.arr_location_code = :flyingTo ELSE b.status IN (11, 10, 4, 12, 3) END
                    ORDER BY fbod.id DESC
                    LIMIT 1
                ) > 0

            END -- The end of Flying From and To

        -- By Class Name
        -- Param: className
        AND CASE WHEN
                :className != 'all'
            THEN ( SELECT COUNT(fbod.id)
                    FROM booking_origin_destinations fbod
                    WHERE fbod.booking_id = b.id
                    AND fbod.parent_id IS NOT NULL
                    AND CASE WHEN :className = 'economy' THEN fbod.cabin_code = 'Y' WHEN :className = 'first' THEN fbod.cabin_code = 'F' ELSE fbod.cabin_code = 'C' END
                ) > 0
            ELSE
                 b.status IN (11, 10, 4, 12, 3)
            END -- The end of Class Name

        -- By date
        -- Param: bookDate
        AND CASE WHEN
                :bookDate != 'all'
            THEN
                Date(b.created_at) = :bookDate
            ELSE
                b.status IN (11, 10, 4, 12, 3)
            END -- The end of date

        -- By Payment Type
        -- Param: paymentType
        AND CASE WHEN
                :paymentType != 'all'
            THEN
                ( SELECT COUNT(bpt.id)
                FROM booking_payment_transactions bpt
                WHERE bpt.method = :paymentType
                ) > 0
            ELSE
                b.status IN (11, 10, 4, 12, 3)
            END -- The end of Payment Type

        -- By booking status
        -- Param: bookStatus
        AND CASE WHEN
                :bookStatus != 'all'
            THEN

                -- Case of COMPLETE AND UPCOMING
                CASE WHEN ( :bookStatus = 'complete' OR :bookStatus = 'upcoming' ) THEN

                    CASE WHEN -- Case COMPLETE
                        :bookStatus = 'complete'
                        THEN (
                            SELECT COUNT(bod.id) FROM booking_origin_destinations bod
                            WHERE bod.booking_id = b.id
                            -- Where Date and Convert TZ date
                            AND -- Flight depature datetime and convert to UTC
                                DATE(CONVERT_TZ(bod.dep_date, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END ), '+00:00')

                                -- User locale current time zone and convert to UTC
                                ) < CONVERT_TZ(CURRENT_TIMESTAMP, CONCAT(CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END ) , '+00:00')
                            ORDER BY bod.id DESC
                            LIMIT 1 ) > 0

                     ELSE -- Case UPCOMING
                        ( SELECT COUNT(bod.id)
                            FROM booking_origin_destinations bod
                            WHERE bod.booking_id = b.id

                            -- Where Date and Convert TZ date
                            AND DATE(
                                    -- Flight depature datetime and convert to UTC
                                    CONVERT_TZ(bod.dep_date, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END ), '+00:00')
                                    -- User locale current time zone and convert to UTC
                                    ) >= CONVERT_TZ(CURRENT_TIMESTAMP, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END  ), '+00:00')

                            ORDER BY bod.id DESC
                            LIMIT 1) > 0
                     END


                ELSE -- Case CANCEL
                    b.`status` = 3
                END

            ELSE
                 b.status IN (11, 10, 4, 12, 3)
            END -- The end of booking status

    ELSE
        b.status IN (11, 10, 4, 12, 3)
    END -- The end of filter

-- SEARCH BOOKING
AND CASE WHEN
        :action = 'search'
    THEN

        -- By trip type
        b.trip_type LIKE :keyword '%'

        -- By pnr code
        OR b.itinerary_ref LIKE :keyword '%'

        -- By booking code
        OR b.booking_code LIKE :keyword '%'

        -- By contact person
        OR b.cont_fullname LIKE :keyword '%'

        -- By date
        OR Date(b.created_at) LIKE :keyword '%'

        -- By Class Name
        OR ( SELECT COUNT(fbod.id)
            FROM booking_origin_destinations fbod
            WHERE fbod.booking_id = b.id
            AND fbod.parent_id IS NOT NULL
            AND (
                IF( :keyword = 'economy', fbod.cabin_code = 'Y' , 0)
                OR IF( :keyword = 'first', fbod.cabin_code = 'F' , 0)
                OR IF( :keyword = 'business', fbod.cabin_code = 'C' , 0 )
            )
        ) > 0

        -- By stakeholder name
        OR (SELECT COUNT(su.id)
            FROM stakeholder_users su
            WHERE su.id = b.stakeholder_user_id
            AND CONCAT(su.last_name,' ', su.first_name) LIKE '%' :keyword '%'
        ) > 0

		-- By booking status
		OR IF( :keyword = 'complete' OR :keyword = 'upcoming' ,

                -- If TRUE condition between COMPLETE and UPCOMING
                IF( :keyword = 'complete',

                    -- Condition for complete
                    (   SELECT COUNT(bod.id)
                        FROM booking_origin_destinations bod
                        WHERE bod.booking_id = b.id

                        -- Where Date and Convert TZ date
                        AND DATE(

                                -- Flight depature datetime and convert to UTC
                                CONVERT_TZ(bod.dep_date, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END ) , '+00:00')

                                -- User locale current time zone and convert to UTC
                                ) < CONVERT_TZ(CURRENT_TIMESTAMP, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END) , '+00:00')

                        ORDER BY bod.id DESC
                        LIMIT 1

                    ) > 0

                    ,

                    -- Condition for upcoming
                    (   SELECT COUNT(bod.id)
                        FROM booking_origin_destinations bod
                        WHERE bod.booking_id = b.id

                        -- Where Date and Convert TZ date
                        AND DATE(

                                -- Flight depature datetime and convert to UTC
                                CONVERT_TZ(bod.dep_date, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END ), '+00:00')

                                -- User locale current time zone and convert to UTC
                                ) >= CONVERT_TZ(CURRENT_TIMESTAMP, CONCAT( CASE WHEN bod.dep_timezone >= 0 THEN CONCAT('+', bod.dep_timezone,':00') ELSE CONCAT(bod.dep_timezone,':00') END ), '+00:00')

                        ORDER BY bod.id DESC
                        LIMIT 1

                    ) > 0

                )

            ,
                -- Booking status Cancelation and Fail
                IF( :keyword = 'cancel',  b.`status` = 3 , b.`status` IN (10, 12, 4) )
		    )

    ELSE
        b.status IN (11, 10, 4, 12, 3)
    END

GROUP BY pnrCode
ORDER BY bookDate DESC
