SELECT
    b.id AS bookingId,
    b.booking_code AS bookingCode,
    b.itinerary_ref AS prnCode,
    b.trip_type AS tripType,
    bod.className,
    (
        SELECT COUNT(`pass_type`)
        FROM booking_travel_itineraries bti
        WHERE bti.booking_id = b.id
    ) AS totalPass,
    ( b.total_amount + b.markup_amount + b.markup_pay_amount ) AS totalCost,
    b.dis_pay_met_amount AS paymentDiscount,
    ( ( b.total_amount + b.markup_amount + b.markup_pay_amount ) - b.dis_pay_met_amount ) AS grandTotal

FROM bookings b

    INNER JOIN
     (
         SELECT
             bod.booking_id,
             CASE

                 WHEN (bod.cabin_code = 'Y') THEN "Economy"
                 WHEN (bod.cabin_code = 'F') THEN  "First"
                 WHEN (bod.cabin_code = 'C') THEN  "Business"

                 END AS className,
             bod.cabin_code

         FROM booking_origin_destinations bod

         WHERE bod.parent_id IS NOT NULL
           AND (
                 IF( 'allclass' = :classType, bod.cabin_code IN ('Y', 'F', 'C', 'S', 'P', 'J'), 0 )
                 OR IF( 'economy' = :classType, bod.cabin_code = 'Y' , 0)
                 OR IF( 'first' = :classType, bod.cabin_code = 'F' , 0)
                 OR IF( 'business' = :classType, bod.cabin_code = 'C' , 0 )
             )

         GROUP BY bod.booking_id

     ) bod ON bod.booking_id = b.id

WHERE ( IF('skyuser' = :userType, b.stakeholder_user_id = :userId AND b.stakeholder_company_id IS NULL,
            IF('company' = :userRole, b.stakeholder_user_id = :userId OR b.stakeholder_company_id = :companyId,
                b.stakeholder_user_id = :userId AND b.stakeholder_company_id = :companyId)))

  AND b.booking_type = 'flight'

  AND ( b.created_at >= :startDate AND b.created_at <= :endDate)

  AND (
        IF( 'alltrip' = :tripType, b.trip_type IN ('OneWay', 'Return', 'Other'), 0 )
        OR IF( 'oneway' = :tripType, b.trip_type = 'OneWay' , 0)
        OR IF( 'return' = :tripType, b.trip_type = 'Return' , 0)
        OR IF( 'multicity' = :tripType, b.trip_type = 'Other' , 0 )
   )

ORDER BY b.created_at DESC