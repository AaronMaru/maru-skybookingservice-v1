SELECT
COUNT(b.id) AS bookingQty,
IFNULL( SUM(( SELECT SUM(`pass_qty`) FROM booking_travel_itineraries AS bti WHERE bti.booking_id = b.id) ), 0 ) AS totalPassenger,
IFNULL(SUM( b.total_amount + b.markup_amount + b.markup_pay_amount ), 0) AS totalAmount,
IFNULL(SUM(b.dis_pay_met_amount), 0) AS paymentDiscount,
IFNULL(SUM( ( b.total_amount + b.markup_amount + b.markup_pay_amount ) - b.dis_pay_met_amount ), 0) AS grandTotal

FROM bookings b

WHERE CASE WHEN 'skyuser' = :userType
    THEN
        (b.stakeholder_user_id = :skyuserId AND b.stakeholder_company_id IS NULL)
    ELSE
        -- Condition for Skyowner
        CASE WHEN :userRole = 'ADMIN'
            THEN
                b.stakeholder_company_id = :companyId
            ELSE
                b.stakeholder_user_id = :skyuserId AND b.stakeholder_company_id = :companyId
            END
    END

AND b.booking_type = 'flight'
AND ( b.created_at >= :startDate AND b.created_at <= :endDate )

AND CASE
    WHEN 'ALL' = :tripType THEN b.trip_type IN ('OneWay', 'Return', 'Other')
    WHEN 'ONEWAY' = :tripType THEN b.trip_type = 'OneWay'
    WHEN 'ROUND' = :tripType THEN b.trip_type = 'Return'
    WHEN 'MULTICITY' = :tripType THEN b.trip_type = 'Other'
    END

AND (   SELECT COUNT(bod.booking_id)
        FROM booking_origin_destinations bod
        WHERE bod.parent_id IS NOT NULL
        AND bod.booking_id = b.id
        AND CASE
            WHEN 'ALL' = :classType THEN  bod.cabin_code IN ('Y', 'F', 'C', 'S', 'P', 'J')
            WHEN 'ECONOMY' = :classType THEN bod.cabin_code = 'Y'
            WHEN 'FIRST' = :classType THEN bod.cabin_code = 'F'
            WHEN 'BUSINESS' = :classType THEN bod.cabin_code = 'C'
            END
    ) > 0